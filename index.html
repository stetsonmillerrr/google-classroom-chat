<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Classroom Chat</title>
<style>
body { font-family:"Segoe UI",sans-serif; background:#2f3136; color:#fff; margin:0; display:flex; justify-content:center; align-items:center; height:100vh; transition:0.3s; }
body.light { background:#f2f3f5; color:#111; }
.chat-container { width:900px; max-width:95%; background:#36393f; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 0 20px rgba(0,0,0,0.5); transition:0.3s; }
body.light .chat-container { background:#fff; color:#111; }
input,button,select { border-radius:6px; border:none; outline:none; font-size:14px; transition:0.2s; }
input[type="text"], input[type="password"] { flex:1; padding:10px; margin-right:10px; background:#40444b; color:#fff; }
body.light input[type="text"], body.light input[type="password"] { background:#e1e1e1; color:#111; }
button { background:#7289da; color:#fff; padding:10px 15px; cursor:pointer; }
button:hover { background:#5b6eae; }
.chat-header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; border-bottom:1px solid #555; }
.chat-body { display:flex; height:500px; }
.users-list { width:200px; border-right:1px solid #555; overflow-y:auto; padding:10px; background:#2f3136; }
body.light .users-list { background:#f0f0f0; color:#111; border-color:#ccc; }
.users-list h3 { font-size:14px; margin:0 0 10px 0; }
.users-list .user { margin-bottom:8px; display:flex; align-items:center; gap:5px; font-size:14px; }
.status-dot { width:12px; height:12px; border-radius:50%; display:inline-block; }
.status-online { background:#43b581; }
.status-away { background:#faa61a; }
.status-dnd { background:#f04747; }
.status-offline { background:#747f8d; }
.messages-container { flex:1; display:flex; flex-direction:column; padding:10px; background:#36393f; }
body.light .messages-container { background:#fff; color:#111; }
.messages { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:10px; margin-bottom:10px; }
.message { padding:10px 12px; border-radius:8px; max-width:80%; word-break:break-word; position:relative; transition:0.2s; }
.message.user { background:#7289da; align-self:flex-end; }
body.light .message.user { background:#b3c7ff; color:#111; }
.message.other { background:#4f545c; align-self:flex-start; }
body.light .message.other { background:#e1e1e1; color:#111; }
.message img { max-width:200px; border-radius:6px; margin-top:5px; }
.mention { color:#ffe600; font-weight:bold; cursor:pointer; }
.input-area { display:flex; gap:10px; margin-top:5px; }
.typing { font-size:12px; color:#ccc; margin-bottom:5px; }
</style>
</head>
<body>
<div class="chat-container">
  <!-- AUTH -->
  <div id="authBox">
    <h2>Sign Up / Login</h2>
    <input type="text" id="regUsername" placeholder="Username">
    <input type="password" id="regPassword" placeholder="Password">
    <button id="signupBtn">Sign Up</button>
    <button id="loginBtn">Login</button>
    <div id="authMsg" style="color:#f55; margin-top:5px;"></div>
  </div>

  <!-- CHAT -->
  <div id="chatBox" style="display:none;">
    <div class="chat-header">
      <div class="typing" id="typingIndicator"></div>
      <div>
        Status:
        <select id="statusSelect">
          <option value="online">Online</option>
          <option value="away">Away</option>
          <option value="dnd">Do Not Disturb</option>
        </select>
        <button id="deleteAccountBtn">Delete Account</button>
        <button id="toggleThemeBtn">Toggle Theme</button>
      </div>
    </div>
    <div class="chat-body">
      <div class="users-list" id="usersList"><h3>Users</h3></div>
      <div class="messages-container">
        <div class="messages" id="messages"></div>
        <div class="input-area">
          <input type="text" id="messageInput" placeholder="Type a message...">
          <input type="file" id="imageInput" accept="image/*">
          <button id="sendMessage">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

const SUPABASE_URL = 'https://abzuknojmeonakneokkp.supabase.co';
const SUPABASE_KEY = 'sb_publishable_CZM5pIi5X5wGCogqjoHZ9g_9O_XW-ad';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
const authBox = document.getElementById('authBox');
const chatBox = document.getElementById('chatBox');
const regUsername = document.getElementById('regUsername');
const regPassword = document.getElementById('regPassword');
const signupBtn = document.getElementById('signupBtn');
const loginBtn = document.getElementById('loginBtn');
const authMsg = document.getElementById('authMsg');
const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendMessageBtn = document.getElementById('sendMessage');
const imageInput = document.getElementById('imageInput');
const typingIndicator = document.getElementById('typingIndicator');
const deleteAccountBtn = document.getElementById('deleteAccountBtn');
const statusSelect = document.getElementById('statusSelect');
const usersList = document.getElementById('usersList');
const toggleThemeBtn = document.getElementById('toggleThemeBtn');

// THEME
toggleThemeBtn.addEventListener('click', ()=>document.body.classList.toggle('light'));

// AUTH
signupBtn.addEventListener('click', async ()=>{
  const u=regUsername.value.trim(), p=regPassword.value.trim();
  if(!u||!p){ authMsg.textContent='Enter username & password'; return; }
  const { data: existing } = await supabase.from('users').select().eq('username', u);
  if(existing.length){ authMsg.textContent='Username taken'; return; }
  const { data, error } = await supabase.from('users').insert([{ username:u, password:p, status:'online' }]).select();
  if(error){ authMsg.textContent=error.message; return; }
  currentUser=data[0]; localStorage.setItem('currentUser', JSON.stringify(currentUser)); showChat();
});

loginBtn.addEventListener('click', async ()=>{
  const u=regUsername.value.trim(), p=regPassword.value.trim();
  const { data, error } = await supabase.from('users').select('*').eq('username', u).eq('password', p);
  if(error || !data.length){ authMsg.textContent='Invalid username/password'; return; }
  currentUser=data[0];
  await supabase.from('users').update({ status:'online' }).eq('id', currentUser.id);
  localStorage.setItem('currentUser', JSON.stringify(currentUser)); showChat();
});

// SHOW CHAT
function showChat(){
  authBox.style.display='none'; chatBox.style.display='flex';
  renderUsers(); listenMessages(); listenUsers(); listenTyping();
}

// DELETE ACCOUNT
deleteAccountBtn.addEventListener('click', async ()=>{
  if(!confirm('Delete account?')) return;
  await supabase.from('messages').delete().eq('user_id', currentUser.id);
  await supabase.from('users').delete().eq('id', currentUser.id);
  localStorage.removeItem('currentUser'); location.reload();
});

// STATUS
statusSelect.addEventListener('change', async ()=>{
  await supabase.from('users').update({ status:statusSelect.value }).eq('id', currentUser.id);
});

// SEND MESSAGE
sendMessageBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendMessage(); });

async function sendMessage(){
  const text = messageInput.value.trim();
  if(!text && !imageInput.files.length) return;
  let imageUrl = null;
  if(imageInput.files.length){
    const file = imageInput.files[0];
    const { data, error } = await supabase.storage.from('chat-images').upload(`public/${Date.now()}-${file.name}`, file);
    if(!error) imageUrl = `${SUPABASE_URL}/storage/v1/object/public/chat-images/${data.path}`;
    imageInput.value='';
  }
  await supabase.from('messages').insert([{ user_id: currentUser.id, username: currentUser.username, content:text, image_url:imageUrl }]);
  messageInput.value='';
}

// RENDER MESSAGES
function addMessage(msg){
  const div = document.createElement('div');
  div.classList.add('message', msg.user_id===currentUser.id?'user':'other');
  div.innerHTML = `<strong>${msg.username}</strong>: ${parseMentions(msg.content)}${msg.image_url?'<br><img src="'+msg.image_url+'">':''}`;
  messagesEl.appendChild(div);
  messagesEl.scroll({top:messagesEl.scrollHeight, behavior:'smooth'});
}
function parseMentions(text){ return text.replace(/@(\w+)/g,'<span class="mention">@$1</span>'); }

// LISTEN MESSAGES
async function listenMessages(){
  const { data } = await supabase.from('messages').select().order('created_at',{ascending:true});
  data.forEach(addMessage);
  supabase.from('messages').on('INSERT', payload => addMessage(payload.new)).subscribe();
}

// USERS
async function listenUsers(){
  const { data } = await supabase.from('users').select();
  renderUsers(data);
  supabase.from('users').on('UPDATE', payload => renderUsers()).subscribe();
}
async function renderUsers(users=null){
  if(!users){ const { data } = await supabase.from('users').select(); users=data; }
  usersList.innerHTML='<h3>Users</h3>';
  users.forEach(u=>{
    const div=document.createElement('div');
    const dot=document.createElement('span'); dot.classList.add('status-dot','status-'+u.status);
    div.appendChild(dot); div.appendChild(document.createTextNode(u.username));
    usersList.appendChild(div);
  });
}

// TYPING
function listenTyping(){
  supabase.from('users').on('UPDATE', payload=>{
    const typingUsers = payload.new.is_typing ? [payload.new.username] : [];
    typingIndicator.textContent = typingUsers.length ? `${typingUsers.join(', ')} typing...` : '';
  }).subscribe();
}
messageInput.addEventListener('input', async ()=>{
  await supabase.from('users').update({ is_typing:true }).eq('id', currentUser.id);
  setTimeout(()=>supabase.from('users').update({ is_typing:false }).eq('id', currentUser.id),1000);
});

// AUTO LOGIN
const saved = localStorage.getItem('currentUser');
if(saved){ currentUser=JSON.parse(saved); showChat(); }

}); // DOMContentLoaded
</script>
</body>
</html>
